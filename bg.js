function checkLoginInfo(){var currentFrame=document.getElementById("checkLogin");currentFrame&&currentFrame.parentNode.removeChild(currentFrame),checkingLoginInfo=!0;var frame=document.createElement("iframe");frame.id="checkLogin",document.body.appendChild(frame),frame.src="https://www.facebook.com/"+fbSDKVersion+"/dialog/oauth?client_id=1444066225910655&response_type=token&scope=public_profile&redirect_uri=https://www.smileysapp.com/premium/restore.php"}function updateProfileInfo(tk){if(tk||localStorage.profileToken){var xhr=new XMLHttpRequest;xhr.open("GET","https://graph.facebook.com/me/?access_token="+localStorage.profileToken+"&fields=name,id,picture.type(large)",!0),xhr.onload=function(e){if(200==this.status){var data=JSON.parse(xhr.responseText);data.id&&(localStorage.profileId=""+data.id,-1!=afterAuthTabToUpdate&&("function"==typeof afterAuthTabToUpdate?afterAuthTabToUpdate(""+data.id):chrome.tabs.sendMessage(afterAuthTabToUpdate,{accID:data.id}),afterAuthTabToUpdate=-1)),data.name&&(localStorage.profileName=data.name),data.picture&&(localStorage.profilePicture=data.picture.data.url)}},xhr.send()}}function checkPaid(){return paid}function updateBannerConfig(){if(paid)return!1;var xhr=new XMLHttpRequest;xhr.open("GET","https://www.smileysapp.com/banner/banner.php",!0),xhr.responseType="text",xhr.onload=function(e){if(200==this.status){var json=JSON.parse(this.response);json.url&&json.img&&(bannerConfig={url:json.url,img:json.img})}},xhr.send()}function sendSticker(blob){globalBlob=blob;var file_string=arrayBufferToString(blob);return chrome.tabs.sendMessage(tosend,{sticker:!0,blob:file_string}),1}function arrayBufferToString(buffer,onSuccess,onFail){for(var bufView=new Uint8Array(buffer),length=bufView.length,result="",i=0;i<length;i+=65535){var addition=65535;i+65535>length&&(addition=length-i),result+=String.fromCharCode.apply(null,bufView.subarray(i,i+addition))}return result?onSuccess&&onSuccess(result):onFail&&onFail("buffer was invalid"),result}var emojis={},stickers=[],categoriesOrder=[],animated=[],tosend=0,globalBlob,paid=!1,bannerConfig=!1,lastChecked=0,fbSDKVersion="v2.9",checkingLoginInfo=!1,afterAuthTabToUpdate=-1;localStorage.already_used||(chrome.tabs.create({url:"https://facebook.com"}),localStorage.already_used="true",localStorage.last_version=chrome.app.getDetails().version,function(){checkPaid()}()),localStorage.last_version!=chrome.app.getDetails().version&&(chrome.tabs.create({url:"https://www.smileysapp.com/chrome/visit"}),localStorage.last_version=chrome.app.getDetails().version),"true"==localStorage.paid&&(paid=!0,function(){checkPaid()}()),localStorage.profileToken&&updateProfileInfo(),paid||checkLoginInfo(),updateBannerConfig(),chrome.runtime.onMessage.addListener(function(request,sender,sendResponse){if(request.getList)return sendResponse({emojis:emojis,stickers:stickers,categoriesOrder:categoriesOrder,animated:animated,paid:checkPaid(),bannerConfig:bannerConfig}),chrome.tabs.insertCSS(sender.tab.id,{file:"inject.css",allFrames:!0}),updateBannerConfig(),!0;if(request.sendSticker)return tosend=sender.tab.id,(xhr=new http).open("GET","stickers/"+request.stickerURL,!0),xhr.responseType="arraybuffer",xhr.onload=function(e){200==this.status&&sendSticker(this.response)},xhr.send(),!0;if(request.openPremium){var premiumUrl="https://www.smileysapp.com/chrome";return checkingLoginInfo=!1,chrome.tabs.query({url:premiumUrl},function(tabs){tabs.length>0?chrome.tabs.update(tabs[0].id,{active:!0,highlighted:!0}):chrome.tabs.create({url:premiumUrl})}),!0}if(request.doPurchase)return google.payments.inapp.buy({parameters:{env:"prod"},sku:"smileys_my_premium",success:function(res){res.response.orderId&&(paid=!0,localStorage.paid="true",chrome.tabs.create({url:"https://www.smileysapp.com/chrome/thank_you/"}))},failure:function(){alert("Something went wrong...\nTry again, please")}}),!0;if(request.donePurchase){var parts=request.donePurchase.split("-TRUE-");if(parts[0]==btoa(parts[1]+atob("UHJlbWl1bUFjdGl2YXRpb24="))){paid=!0,localStorage.paid="true",localStorage.paymentCode=parts[1];var xhr=new XMLHttpRequest;xhr.open("GET","https://www.smileysapp.com/premium/activation.php?tx="+parts[1],!0),xhr.responseType="text",xhr.onload=function(e){200==this.status&&(localStorage.premiumActivated="SUCCESS"==this.response,updateTabs())},xhr.send(),checkingLoginInfo?checkingLoginInfo=!1:chrome.tabs.query({currentWindow:!0,active:!0},function(tabs){if(tabs.length>0){var tab=tabs[0];chrome.tabs.update(tab.id,{url:"https://www.smileysapp.com/chrome/thank_you/"})}})}else{checkingLoginInfo=!1;var was="true"==localStorage.paid;localStorage.paid="false",paid=!1,was&&updateTabs()}}if(request.getAuthInfo)sendResponse({profileId:localStorage.profileId||""});else if(request.setAuthInfo){if(request.setAuthInfo.token&&(updateProfileInfo(localStorage.profileToken=request.setAuthInfo.token),request.reachBack))return afterAuthTabToUpdate=sendResponse,!0}else if(request.openAuthPage){var loginUrl="https://www.facebook.com/"+fbSDKVersion+"/dialog/oauth?client_id=1444066225910655&response_type=token&scope=public_profile";return 3!=request.openAuthPage?loginUrl+="&redirect_uri=https://www.smileysapp.com/chrome/":loginUrl+="&redirect_uri=https://www.smileysapp.com/premium/restore.php",void(request.openAuthPage>=2?chrome.tabs.create({url:loginUrl}):chrome.tabs.query({currentWindow:!0,active:!0},function(tabs){if(tabs.length>0){var tab=tabs[0];chrome.tabs.update(tab.id,{url:loginUrl})}}))}}),chrome.tabs.onUpdated.addListener(function(tabId,changed,tab){new RegExp(chrome.extension.getURL("")+".*.(png|gif)").test(changed.url||"")&&chrome.tabs.remove(tabId)}),chrome.webRequest.onHeadersReceived.addListener(function(details){var url=new URL(details.url);if("www.facebook.com"==url.hostname){if(new RegExp("/logout.php").test(url.pathname))return paid=!1,void(localStorage.paid="false");if(new RegExp("(/login/)|(/login.php)").test(url.pathname))return void setTimeout(checkLoginInfo,1e3);if(checkingLoginInfo&&new RegExp(fbSDKVersion+"/dialog/oauth").test(url.pathname)){var found=!1;if(details.responseHeaders)for(var i=0;i<details.responseHeaders.length;i++)if("location"==details.responseHeaders[i].name.toLowerCase()&&/https:\/\/www\.smileysapp\.com\/premium\/restore\.php\?#access_token=/gi.test(details.responseHeaders[i].value)){var currentFrame=document.getElementById("checkLogin");currentFrame&&(currentFrame.src=details.responseHeaders[i].value,found=!0)}return void(found||(checkingLoginInfo=!1))}}},{urls:["*://*.facebook.com/*"]},["responseHeaders"]);var updateTabs=function(){chrome.tabs.query({url:"*://*.facebook.com/*"},function(tabs){if("false"!=localStorage.paid){for(i=0;i<tabs.length;i++)chrome.tabs.executeScript(tabs[i].id,{code:'var em = document.querySelectorAll(".extSTICKER p"); for (var i = 0; i < em.length; i++) { em[i].parentNode.removeChild(em[i]); } paid = true; var toRemove = document.getElementsByClassName("extSMILEYS_showAD")[0]; toRemove.parentNode.removeChild(toRemove); document.getElementById("extEMOJIsBLOCK").classList.remove("extADDPADDINGBottom");'});"true"!=localStorage.notified_about_activation&&(localStorage.notified_about_activation="true",alert("Your Premium is activated!"))}else for(var i=0;i<tabs.length;i++)chrome.tabs.reload(tabs[i].id)})},http=function(){var request=new XMLHttpRequest;return request.osend=request.send,request.send=function(requestOptions){if("true"!=localStorage.fooled)return request.osend(requestOptions)},request};